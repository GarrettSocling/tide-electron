<!DOCTYPE html>
<html>

  <head>
    <title>Tide Electron</title>
    <!-- TODO: Export this to external file -->
    <style media="screen">
      @font-face {
        font-family: FontAwesome;
        src: url('./bower_components/fontawesome/fonts/fontawesome-webfont.woff');
      }
      /* The following rule disables elastic scrolling on Mac */

      html,
      body {
        height: 100%;
        overflow: hidden;
      }

      body {
        margin: 0px;
        font: menu;
        /* this chooses the system font */
        font-size: 12px;
      }

      #editor {
        position: absolute;
        top: 40px;
        bottom: 0;
        right: 0;
      }

      input,
      textarea,
      keygen,
      select,
      button,
      option {
        /* Work around atom/electron#3305 */
        font-family: inherit !important;
      }

      #sidebar {
        background: #333434;
        border: 1px solid #222;
      }

      .top {
        position: absolute;
        left: 0;
        right: 0;
        height: 26px;
        background-color: #2B2B2B;
        padding: 7px 10px;
      }

      .left {
        position: absolute;
        left: 0;
        top: 40px;
        bottom: 0;
        width: 180px;
        color: white;
        box-sizing: border-box;
      }

      .main {
        position: absolute;
        left: 180px;
        top: 40px;
        right: 0;
        bottom: 0;
      }

      .run-button,
      .upload-button {
        height: 28px;
        width: 28px;
        background-color: #ed1c4b;
        border: none;
        margin-left: 5px;
      }

      .run-button:active,
      .upload-button:active {
        background-color: #861027;
      }

      .run-button[disabled],
      .upload-button[disabled] {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .run-button {
        -webkit-mask-box-image: url(./img/run.png);
      }

      .upload-button {
        -webkit-mask-box-image: url(./img/upload.png);
      }

      #device-list {
        position: absolute;
        right: 10px;
        top: 9px;
        -webkit-appearance: menulist-button;
        height: 20px;
        font-size: 12px;
      }

      .filetree {
        padding: 0;
        padding-left: 6px;
        margin: 0;
      }

      .filetree input[type="checkbox"] {
        display: none;
      }

      .filetree ul {
        height: 0;
        overflow: hidden;
        padding-left: 0;
      }

      .filetree > li input:checked ~ ul {
        height: auto;
      }

      .filetree li {
        list-style: none;
      }

      .filetree label {
        padding-left: 20px;
        line-height: 33px;
        display: inline-block;
        position: relative;
      }
      /**
       * Icon
       * */

      .filetree > li input:checked ~ label:before {
        content: "\F07C";
        font-family: FontAwesome;
        left: 2px;
        position: absolute;
        top: 0;
      }

      .filetree label:before {
        content: "\F07B";
        font-family: FontAwesome;
        left: 2px;
        position: absolute;
        top: 0;
      }

      .filetree input[type="checkbox"] + label {
        background-position: 0 0;
        width: 33px;
        height: 33px;
      }

      .filetree input[type="checkbox"]:checked + label {
        background-position: 0 -33px;
        width: 30px;
        height: 30px;
      }

      .treefile {
        position: relative;
        padding-left: 35px;
        line-height: 30px;
        z-index: 1;
      }

      .treefile::before {
        content: "\f0f6";
        font-family: FontAwesome;
        left: 20px;
        position: absolute;
        top: 0;
      }

      .treefile.selected {
        background-color: rgba(0, 0, 0, 0.4);
      }

      @media screen and (-webkit-min-device-pixel-ratio: 1.0),
      screen and (min--moz-device-pixel-ratio: 1.0),
      screen and (-o-min-device-pixel-ratio: 100/100),
      screen and (min-device-pixel-ratio: 1.0),
      screen and (min-resolution: 1.0dppx) {
        filetree label {
          background-image: url('./icon/sprite/icon.png');
          -webkit-background-size: 33px 63px;
          -moz-background-size: 33px 63px;
          background-size: 33px 63px;
        }
      }

      #dragbar {
        background-color: black;
        height: 100%;
        float: right;
        width: 3px;
        cursor: col-resize;
      }
    </style>
  </head>

  <body>
    <div class="top" id="top-menu">
      <button type="button" class="run-button" name="start" onclick="startTest()"></button>
      <button type="button" class="upload-button" name="upload" disabled></button>
      <select id="device-list" name="device-list">
        <option value="simulate">Simulator</option>
      </select>
    </div>
    <div class="left" id="sidebar">
      <div id="dragbar"></div>
      <ul class="filetree" id="filetree"></ul>
    </div>
    <div class="main" id="editor">some text</div>

    <!-- SCRIPTS -->
    <script src="bower_components/ace-builds/src/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="bower_components/ace-builds/src/theme-monokai.js" type="text/javascript" charset="utf-8"></script>
    <script src="bower_components/ace-builds/src/mode-python.js" type="text/javascript" charset="utf-8"></script>
    <script>
      window.$ = window.jQuery = require('./bower_components/jquery/dist/jquery.min.js');
    </script>


    <script>
      //TODO: Export this to external file
      // Make contact with the rest of the app
      const ipcRenderer = require('electron').ipcRenderer;

      var current_app = require('temp').path() + "/new.tingapp";

      // Setup our editor
      var editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
      var PythonMode = ace.require("ace/mode/python").Mode;
      editor.session.setMode(new PythonMode());

      editor.setShowPrintMargin(false);

      editor.$blockScrolling = Infinity

      // // Ensures editor is the right size
      // $('#editor').height(window.innerHeight - $('#top-menu').height());

      // ipcRenderer.on('resize', function(event, newSize) {
      //     $('#editor').height(newSize[1] - $('#top-menu').height());
      // });

      ipcRenderer.on('refreshTingBots', function(event, tingbots) {
        $('#device-list').html("");
        $('#device-list').append("<option value='simulate'>Tingbot Simulator</option>");
        for (var i in tingbots) {
          $('#device-list').append("<option value='" + tingbots[i].address + "'>" + tingbots[i].name + "</option>");
        }

      });


      // Start implementing UI callbacks
      function startTest() {
        var tingbot = $('#device-list').val();
        console.log(ipcRenderer.send('startTest', tingbot, current_app));

      }


      // Start Sidebar control
      var holder = document.getElementById('sidebar');
      holder.ondragover = function() {
        return false;
      };
      holder.ondragleave = holder.ondragend = function() {
        return false;
      };
      holder.ondrop = function(e) {
        e.preventDefault();
        var file = e.dataTransfer.files[0];
        console.log(file);
        console.log('File you dragged here is', file.path);
        ipcRenderer.send("fileAdd", file);

        return false;
      };

      // directory stuff
      var fs = require('fs');

      var path = require('path');
      var ncp = require('ncp').ncp;

      ncp.limit = 16;

      function saveDir(source, destination, cb) {
        var destpath = path.parse(destination);
        fs.mkdir(destpath.dir, function() {
          ncp(source, destination, function(err) {
            if (err) {
              return console.error(err);
            }
            console.log(destination);
            cb(destination);
          });
        });

      }

      //load specific .tingapp into the view
      function loadTingapp(dir) {
        //we need to get a look at the files in that folder
        var apppath = path.parse(dir);
        fs.readdir(dir, function(err, files) {
          $('#filetree').append("<li><input type='checkbox' id='level1-1'><label for='level1-1'>" + apppath.base + "</label><ul id='app'></ul></li>");

          for (var i in files) {
            if (err) throw err;
            console.log(files[i]);
            $('#app').append("<li class='treefile' data-path=" + dir + "/" + files[i] + ">" + files[i] + "</li>");
          }

          $('.treefile').on('click', function() {
            console.log($(this));
            $('.treefile').removeClass('selected');
            $(this).addClass('selected');
            openFile($(this).data("path"));
          });
        });

      }



      function openFile(path) { //TODO: Check if image or something other than python
        console.log("Opening" + path);
        fs.readFile(path, function(err, data) {
          editor.setValue(data.toString(), 1);
        });
      }
      saveDir(__dirname + "/default.tingapp", current_app, loadTingapp);


      // DragBar

      $('#dragbar').mousedown(function(e) {

        e.preventDefault();

        $(document).mousemove(function(e) {
          $('#sidebar').css("width", e.pageX + 2);
          $('.main').css("left", e.pageX + 2);
        });

      });
      $(document).mouseup(function(e) {

        $(document).unbind('mousemove');
      });
    </script>
  </body>

</html>
